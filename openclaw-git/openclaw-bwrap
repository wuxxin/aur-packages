#!/usr/bin/env bash
set -euo pipefail

# Configuration
OPENCLAW_BIN="/usr/bin/openclaw"

# Check if the first argument is --exec and a second argument exists
if [[ "${1:-}" == "--exec" ]] && [[ -n "${2:-}" ]]; then
    OPENCLAW_BIN="$2"
    shift 2 # Remove --exec and the path from the argument list
fi

# Ensure necessary directories exist
mkdir -p "${HOME}/.openclaw" "${HOME}/.config/openclaw" "${HOME}/.openclaw-bwrap"

BWRAP_ARGS=(
    # Unshare namespaces for isolation
    --unshare-all
    --share-net
    --die-with-parent
    --new-session

    # Mount host root read-only
    --ro-bind / /

    # Overlay a writable tmpfs on /tmp
    --tmpfs /tmp

    # Mount devices and process info
    --dev-bind /dev /dev
    --ro-bind /sys /sys
    --proc /proc

    # Bind the bwrap folder to $HOME
    --bind "$HOME/.openclaw-bwrap" "$HOME"

    # --- OVERRIDES ---
    --bind "${HOME}/.openclaw" "${HOME}/.openclaw"
    --bind "${HOME}/.config/openclaw" "${HOME}/.config/openclaw"

    --setenv PATH "$PATH"
    --setenv HOME "$HOME"
)

# Optional: Add extra arguments via environment variable
if [ -n "${OPENCLAW_BWRAP_EXTRA_ARGS:-}" ]; then
    read -ra EXTRA_ARGS <<<"$OPENCLAW_BWRAP_EXTRA_ARGS"
    BWRAP_ARGS+=("${EXTRA_ARGS[@]}")
fi

# Execute the chosen binary inside bubblewrap
exec bwrap "${BWRAP_ARGS[@]}" "$OPENCLAW_BIN" "$@"
