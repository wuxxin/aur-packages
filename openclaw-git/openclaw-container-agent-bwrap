#!/bin/bash
set -euo pipefail

# Configuration
OPENCLAW_BIN="/usr/bin/openclaw"
CONTAINER_RUNTIME="${OPENCLAW_CONTAINER_RUNTIME:-podman}"

# Determine socket path based on runtime
if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
    # Podman (rootless) default socket
    # Verify XDG_RUNTIME_DIR is set, otherwise guess
    RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
    CONTAINER_SOCKET="$RUNTIME_DIR/podman/podman.sock"
elif [[ "$CONTAINER_RUNTIME" == "docker" ]]; then
    CONTAINER_SOCKET="/var/run/docker.sock"
else
    echo "Error: Unknown container runtime '$CONTAINER_RUNTIME'. Supported: podman, docker" >&2
    exit 1
fi

if [ ! -S "$CONTAINER_SOCKET" ]; then
    echo "Warning: Container socket not found at $CONTAINER_SOCKET" >&2
fi

# Ensure config directories exist to prevent bind mount errors
mkdir -p "${HOME}/.openclaw" "${HOME}/.config/openclaw" "${HOME}/.openclaw-bwrap"

# Agent needs access to container socket
BWRAP_ARGS=(
    # Unshare namespaces for isolation
    --unshare-all
    --share-net
    --die-with-parent
    --new-session

    # Mount host root read-only
    --ro-bind / /

    # Overlay a writable tmpfs on /tmp
    --tmpfs /tmp

    # Mount devices and process info
    --dev-bind /dev /dev
    --ro-bind /sys /sys
    --proc /proc

    # bind the bwrap folder to $HOME
    --bind "$HOME/.openclaw-bwrap" "$HOME"

    # --- OVERRIDES ---
    --bind "${HOME}/.openclaw" "${HOME}/.openclaw"
    --bind "${HOME}/.config/openclaw" "${HOME}/.config/openclaw"

    # Bind container socket
    --bind "$CONTAINER_SOCKET" "$CONTAINER_SOCKET"

    # Pass socket path env var if needed by certain tools,
    # though standard tools often check default paths.
    # For docker client using podman socket:
    --setenv DOCKER_HOST "unix://$CONTAINER_SOCKET"

    --setenv PATH "$PATH"
    --setenv HOME "$HOME"
)

if [ -n "${OPENCLAW_CONTAINER_AGENT_BWRAP_EXTRA_ARGS:-}" ]; then
    read -ra EXTRA_ARGS <<<"$OPENCLAW_CONTAINER_AGENT_BWRAP_EXTRA_ARGS"
    BWRAP_ARGS+=("${EXTRA_ARGS[@]}")
fi

exec bwrap "${BWRAP_ARGS[@]}" "$OPENCLAW_BIN" agent "$@"
